<script lang="ts">
  import { goto } from "$app/navigation";
  import { PersistedState } from "runed";
  import SelectAvatar from "$svexplib/Games/CoordinationGame/SelectAvatar.svelte";
  import { PUBLIC_ENV } from '$env/static/public';
  import { getRoutePermission, setRoutePermission, gotoNextPermittedRoute, PermissionState } from "$svexplib/Tools/RouteProgression";
  import { routeOrder } from "../routeOrder";
  import debugLib from "debug";
  const debug = debugLib("exp:GameReady");
  const selectedAvatarName = new PersistedState<string | null>("ccg-selected-avatar", null);
  const avatarIsFinalized = new PersistedState<boolean>("ccg-avatar-selected", false);

  function next() {
    if (selectedAvatarName.current === null) {
      alert("Please select a portrait before proceeding.");
      return;
    }
    setRoutePermission('game-ready', PermissionState.NoLongerPermitted);
    gotoNextPermittedRoute('game-ready', routeOrder);
  }

  function skip() {
    if (selectedAvatarName.current === null) {
      selectedAvatarName.current = "";
    }
    setRoutePermission('game-ready', PermissionState.NoLongerPermitted);
    gotoNextPermittedRoute('game-ready', routeOrder);
  }

</script>

# Portrait Selection

{#if !avatarIsFinalized.current}
  <p>Please choose a portrait to represent yourself in the game.</p>
  <SelectAvatar
    onAvatarSelection={(avatar) => {
      debug(`Selected avatar: ${avatar}`);
      selectedAvatarName.current = avatar;
    }}
  />
  <br><br>
{/if}


## Game Ready

When you're ready to begin the game, please click the "Next" button below.

<button id="next-button" onclick={() => next()}>Next</button>

{#if PUBLIC_ENV === 'dev'}
<br><br>
<button id="skip-button" onclick={() => skip()}>Skip</button>
{/if}